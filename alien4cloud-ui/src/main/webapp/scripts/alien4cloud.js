define(function(require) {
  'use strict';

  var states = require('states');
  var modules = require('modules');
  var plugins = require('plugins');
  var _ = require('lodash');
  var angular = require('angular');
  var moment = require('moment');

  require('scripts/layout/layout');

  var alien4cloud = modules.get('alien4cloud', [
    'ngCookies',
    'ngResource',
    'ngSanitize',
    'ui.bootstrap',
    'ui.router',
    'pascalprecht.translate',
    'xeditable',
    'angularMoment'
  ]);

  require(['clipboard'], function(Clipboard) {
    new Clipboard('.btn-cb', {
        text: function(trigger) {
            return trigger.getAttribute("uib-tooltip");
        }
    });
  });

  // bootstrap angular js application
  states.state('home', {
    url: '/',
    templateUrl: 'views/main.html',
    controller: ['$scope', 'authService', 'hopscotchService', '$state', function($scope, authService, hopscotchService, $state) {
      $scope.isAdmin = false;
      var isAdmin = authService.hasRole('ADMIN');
      if (_.defined(isAdmin.then)) {
        authService.hasRole('ADMIN').then(function(result) {
          $scope.isAdmin = result;
        });
      } else {
        $scope.isAdmin = isAdmin;
      }
      $scope.adminTour = function() {
        $state.go('admin');
        hopscotchService.startTour('admin.home');
      };
    }]
  });
  states.state('restricted', {
    url: '/restricted',
    templateUrl: 'views/authentication/restricted.html'
  });

  require('scripts/common/services/rest_technical_error_interceptor');
  var templateInjector = require('a4c-templates');

  alien4cloud.startup = function(configuration) {
    // Path initialization for ace ide so it find modules after minification
    var config = window.ace.require('ace/config');
    config.set('basePath', 'bower_components/ace-builds/src-min-noconflict');

    // add requirements to alien4cloud
    modules.link(alien4cloud);

    alien4cloud.config(['$stateProvider', '$urlRouterProvider', '$httpProvider', '$locationProvider', '$qProvider',
      function($stateProvider, $urlRouterProvider, $httpProvider, $locationProvider, $qProvider) {
        $httpProvider.interceptors.push('restTechnicalErrorInterceptor');
        $httpProvider.defaults.headers.common['A4C-Agent'] = 'AngularJS_UI';
        $urlRouterProvider.otherwise('/');
        states.config($stateProvider);
        $locationProvider.html5Mode(false);
        $locationProvider.hashPrefix('');
        $qProvider.errorOnUnhandledRejections(false);
      }
    ]);

    alien4cloud.config(['$translateProvider',
      function($translateProvider) {
        var defaultLanguage = configuration.defaultLanguage;
        var languageFilePrefix = configuration.prefixLanguage;

        // Default language to load
        $translateProvider.translations({CODE: defaultLanguage});
        $translateProvider.preferredLanguage(defaultLanguage);
        $translateProvider.useCookieStorage();

        /*
        * When running in grunt mode, hashPrefix is set to empty so that we can load translation files as is
        * On build, translation files are renamed to add a hash as prefix.
        * So, hashPrefix is change during the build (see main/build/config/execute.js:revrename) from empty to the prefix hash.
        */
        // WARNING WARNING WARNING WARNING WARNING WARNING
        // we use a map as a hack. In fact, the providing of the hash is done after minification.
        // if we use a simple: var hashPrefix='', the minification process will directly replace hashPrefix in the options.files below with ''
        // when using a map, it will be replaced by {hashPrefix:''}.hashPrefix, allowing us to set the value as we want in execute:revrename
        var complexPrefix = {
          hashPrefix:''
        };

        var options = {
          files: [{
            prefix: 'data/languages/' + complexPrefix.hashPrefix +  languageFilePrefix + '-',
            suffix: '.json'
          }]
        };

        // load translations provided by plugins
        if (!_.isEmpty(plugins.registeredTranlations)) {
          _.each(plugins.registeredTranlations, function(trans) {
            options.files.push({
              prefix: trans.prefix,
              suffix: trans.suffix
            });
          });
        }

        // Static file loader
        $translateProvider.useStaticFilesLoader(options);

      }
    ]);

    alien4cloud.run(['$templateCache', '$rootScope', '$state', '$sce', '$translate', 'editableOptions', 'editableThemes', 'authService', 'restTechnicalErrorInterceptor', 'amMoment', 'featureService',
      function($templateCache, $rootScope, $state, $sce, $translate, editableOptions, editableThemes, authService, restTechnicalErrorInterceptor, amMoment, featureService) {
        restTechnicalErrorInterceptor.$state = $state;
        templateInjector($templateCache);
        var statusFetched = false; // flag to know if we have fetched current user status (logged in and roles)
        $rootScope._ = _;
        $rootScope.dotWb = function(inputStr) {
          return $sce.trustAsHtml(inputStr.replace(/\./g, '.<wbr>'));
        };

        // Context management : to manage transverse property edition context for suggestions
        // The context is a stack, the last entered context will inherit data from all stack.
        $rootScope.contextStack = [];
        $rootScope.currentContext = {type: "root", data: {}};
        $rootScope.contextStack.push($rootScope.currentContext);
        $rootScope.$on('$contextPush', function(event, context) {
          // this event is triggered when entering a child scope
          // we merge the data with previous and add it at the top of the stack
          let mergedData = _.assign({}, $rootScope.currentContext.data, context.data);
          context.data = mergedData;
          $rootScope.contextStack.push(context);
          $rootScope.currentContext = context;
        });
        $rootScope.$on('$contextPoll', function(event) {
          // triggered when leaving a scope, just come back to the last known scope
          $rootScope.contextStack.pop();
          $rootScope.currentContext = $rootScope.contextStack[$rootScope.contextStack.length - 1];
        });

        // check when the state is about to change
        $rootScope.$on('$stateChangeStart', function(event, toState, toParams) {
          if (!statusFetched && _.defined(event)) {
            // we must have the user status before going to a state.
            event.preventDefault();
          }
          authService.getStatus().$promise.then(function() {
            var propagateState = !statusFetched; // if we prevented state change we have to trigger it now that we fetched user status
            statusFetched = true;
            // check all the menu array & permissions
            authService.menu.forEach(function(menuItem) {
              var menuType = menuItem.id.split('.')[1];
              var foundMenuIndex = toState.name.indexOf(menuType);
              if (foundMenuIndex === 0 && menuItem.hasRole === false) {
                $state.go('restricted');
              }
            });
            if (propagateState) {
              // This is needed only if we prevented the default state change (so if user status was'nt fetched).
              $state.go(toState, toParams);
            }
          });
        });

        // state routing
        $rootScope.$on('$stateChangeSuccess', function(event, toState) {
          var forward = states.stateForward[toState.name];
          if (_.defined(forward)) {
            $state.go(forward);
          }
        });

        // lang has changes, let's change moment's locale in order to i18n dates and intervals
        $rootScope.$on('$translateChangeSuccess', function() {
          const lang = $translate.use();
          amMoment.changeLocale(lang);
          moment.locale(lang);
        });

        featureService.displaySecretButton().then(function(data){
          $rootScope.displaySecretButton=data;
        });

        /* angular-xeditable config */
        editableThemes.bs3.inputClass = 'input-sm';
        editableThemes.bs3.buttonsClass = 'btn-sm';
        editableThemes.bs3.submitTpl = '<button type="button" class="btn btn-primary"' +
          ' confirm="{{\'CONFIRM_MESSAGE\' | translate}}"' +
          ' confirm-title="{{\'CONFIRM\' | translate }}"' +
          ' confirm-placement="left"' +
          ' confirm-class="popover"' +
          ' cancel-handler="$form.$cancel()"' +
          ' ng-click="$event.stopPropagation();">' +
          '<span class="fa fa-check"></span>' +
          '</button>';
        editableThemes.bs3.cancelTpl = '<button type="button" class="btn btn-default" ng-click="$form.$cancel()">' +
          '<span class="fa fa-times"></span>' +
          '</button>';
        editableOptions.theme = 'bs3';
      }
    ]);

    angular.bootstrap(document, ['alien4cloud']);
  };

  return alien4cloud;
});
